# Use Deno runtime image
FROM denoland/deno:latest AS base

ARG GIT_REVISION
ENV DENO_DEPLOYMENT_ID=${GIT_REVISION}
ENV DENO_NODE_MODULES_DIR=auto

# Set working directory
WORKDIR /app

# Copy deno.json and deno.lock
COPY deno.json deno.lock ./

# Copy entry points used by deno cache (must exist before caching)
COPY vite.config.ts main.tsx utils.ts ./

# Create a temporary cache directory
RUN mkdir -p /tmp/deno_cache

# Cache dependencies with persistent cache
RUN --mount=type=cache,target=/tmp/deno_cache \
    --mount=type=cache,target=/app/node_modules,sharing=shared \
    DENO_DIR=/tmp/deno_cache \
    deno cache --lock=deno.lock --node-modules-dir=auto vite.config.ts main.tsx

# Ensure Fresh core/plugin are cached for Vite build resolution
RUN --mount=type=cache,target=/tmp/deno_cache \
    --mount=type=cache,target=/app/node_modules,sharing=shared \
    DENO_DIR=/tmp/deno_cache \
    deno cache --lock=deno.lock --node-modules-dir=auto jsr:@fresh/core jsr:@fresh/plugin-vite

# Install npm dependencies (cached)
RUN --mount=type=cache,target=/tmp/deno_cache \
    --mount=type=cache,target=/app/node_modules,sharing=shared \
    DENO_DIR=/tmp/deno_cache \
    deno install --allow-scripts

# Copy source code (changes frequently)
COPY . .

# Build with cache mount
RUN --mount=type=cache,target=/tmp/deno_cache \
    --mount=type=cache,target=/app/node_modules,sharing=shared \
    DENO_DIR=/tmp/deno_cache \
    deno task build

# Expose port
EXPOSE 8000

# Run the application
CMD ["deno", "serve", "-A", "_fresh/server.js"]
