version: "3.8"

services:
  # ArangoDB
  arangodb:
    image: arangodb:latest
    container_name: lifeos-arangodb
    hostname: arangodb
    environment:
      ARANGO_ROOT_PASSWORD: ${ARANGO_ROOT_PASSWORD:-lifeos123}
    ports:
      - "8529:8529"
    volumes:
      - arangodb_data:/var/lib/arangodb3
      - arangodb_apps:/var/lib/arangodb3-apps
    healthcheck:
      test: [
        "CMD-SHELL",
        "arangosh --server.endpoint http://127.0.0.1:8529 --server.username root --server.password \"$ARANGO_ROOT_PASSWORD\" --javascript.execute-string \"db._version()\" >/dev/null 2>&1",
      ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - lifeos-network

  arango-init:
    image: arangodb:latest
    container_name: lifeos-arango-init
    environment:
      ARANGO_ROOT_PASSWORD: ${ARANGO_ROOT_PASSWORD:-lifeos123}
    volumes:
      # ADDED :z for Podman
      - ./scripts/init-arangodb.js:/init/init-arangodb.js:ro,z
    depends_on:
      arangodb:
        condition: service_healthy
    command: >
      arangosh
      --server.endpoint http://arangodb:8529
      --server.username root
      --server.password "${ARANGO_ROOT_PASSWORD:-lifeos123}"
      --server.database _system
      --javascript.execute /init/init-arangodb.js
    restart: "no"
    networks:
      - lifeos-network

  # .NET API Backend
  api:
    build:
      context: ./LifeOS
      dockerfile: Containerfile
    container_name: lifeos-api
    hostname: api
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5120
      - ArangoDB__Endpoint=http://arangodb:8529
      - ArangoDB__Database=lifeos
      - ArangoDB__Username=root
      - ArangoDB__Password=${ARANGO_ROOT_PASSWORD:-lifeos123}
      - MinIO__Endpoint=minio:9000
      - MinIO__AccessKey=${MINIO_ROOT_USER:-minioadmin}
      - MinIO__SecretKey=${MINIO_ROOT_PASSWORD:-minioadmin123}
      - MinIO__UseSSL=false
    ports:
      - "5120:5120"
    depends_on:
      arangodb:
        condition: service_healthy
    networks:
      - lifeos-network

  # MinIO
  minio:
    image: quay.io/minio/minio:latest
    container_name: lifeos-minio
    hostname: minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin123}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - lifeos-network

  # Main Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Containerfile
    container_name: lifeos-frontend
    hostname: frontend
    environment:
      # CHANGED: Use relative path so browser requests go through Caddy
      - VITE_API_URL=/api
    depends_on:
      - api
    networks:
      - lifeos-network

  # Caddy Gateway
  caddy:
    image: caddy:2-alpine
    container_name: lifeos-caddy
    hostname: caddy
    depends_on:
      - frontend
      - garage-frontend
      - flashcards-frontend
      - budget-frontend
    ports:
      - "8000:8000"
    volumes:
      # ADDED :z for Podman
      - ./Caddyfile:/etc/caddy/Caddyfile:ro,z
    networks:
      - lifeos-network

  # Flashcards Frontend
  flashcards-frontend:
    build:
      context: ./frontends/flashcards
      dockerfile: Containerfile
    container_name: lifeos-flashcards
    hostname: flashcards-frontend
    environment:
      - DENO_ENV=production
      - FRESH_BASE_PATH=/flashcards
      # CHANGED: Use relative path
      - VITE_API_URL=/api
      - VITE_UPLOADS_URL=/api
      - DENO_DEPLOYMENT_ID=${GIT_REVISION:-local}
    ports:
      - "8030:8000"
    depends_on:
      - api
      - minio
    networks:
      - lifeos-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/flashcards/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Garage Frontend
  garage-frontend:
    build:
      context: ./frontends/garage
      dockerfile: Containerfile
    container_name: lifeos-garage
    hostname: garage-frontend
    environment:
      - DENO_ENV=production
      - FRESH_BASE_PATH=/garage
      # CHANGED: Use relative path
      - VITE_API_URL=/api
      - VITE_UPLOADS_URL=/api
    depends_on:
      - api
    networks:
      - lifeos-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/garage/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Budget Frontend
  budget-frontend:
    build:
      context: ./frontends/budget
      dockerfile: Containerfile
    container_name: lifeos-budget
    hostname: budget-frontend
    environment:
      - DENO_ENV=production
      - FRESH_BASE_PATH=/budget
      # CHANGED: Use relative path
      - VITE_API_URL=/api
      - DENO_DEPLOYMENT_ID=${GIT_REVISION:-local}
    ports:
      - "8040:8000"
    depends_on:
      - api
    networks:
      - lifeos-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/budget/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  arangodb_data:
    driver: local
  arangodb_apps:
    driver: local
  minio_data:
    driver: local

networks:
  lifeos-network:
    driver: bridge